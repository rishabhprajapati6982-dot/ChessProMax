<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chess Master Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <style>
        :root { --main-bg: #312e2b; --gold: #d4af37; }
        body { background: var(--main-bg); color: white; margin: 0; padding: env(safe-area-inset-top) 0; font-family: sans-serif; overflow-x: hidden; }
        
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #81b64c; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .page { display: none; min-height: 100vh; width: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .active-page { display: flex; }
        #myBoard { width: 92vw; max-width: 450px; }
        .board-waiting { opacity: 0.5; pointer-events: none; } 
        
        .btn-gold { background: var(--gold); color: black; font-weight: 800; padding: 15px 40px; border-radius: 50px; text-transform: uppercase; transition: 0.2s; }
        .btn-gold:active { transform: scale(0.95); }
        .performance-popup { position: absolute; top: 12%; background: rgba(129, 182, 76, 0.95); color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; transform: scale(0); transition: 0.3s; z-index: 100; pointer-events: none; }
        .popup-active { transform: scale(1.1); }
        .score-card { background: #3d3a37; border-radius: 12px; padding: 12px 20px; text-align: center; }
        .settings-btn { background: #3d3a37; padding: 15px; border-radius: 12px; width: 85vw; max-width: 400px; text-align: left; font-weight: bold; }
        .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #4a4541; }
        
        /* New Style for Review Mode Navigation */
        #reviewControls { display: flex; justify-content: space-between; margin-top: 10px; width: 92vw; max-width: 450px; }
        #reviewControls button { background: #57534e; color: white; padding: 8px 15px; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="perfMsg" class="performance-popup">Brilliant!!</div>

    <div id="splashPage" class="page active-page">
        <h1 class="text-4xl font-black text-[#81b64c] mb-6">CHESS PRO</h1>
        <span class="loader"></span>
        <p class="mt-4 text-[10px] uppercase tracking-widest text-gray-500">Initializing Grandmaster AI...</p>
    </div>

    <div id="lobbyPage" class="page">
        <img src="https://images.unsplash.com/photo-1529699211952-734e80c4d42b?q=80&w=600" class="w-[80vw] max-w-xs rounded-2xl shadow-2xl mb-8 border-2 border-gray-700">
        
        <div id="scoreDisplay" class="score-card mb-8 w-[80vw] max-w-xs">
            </div>

        <button onclick="showPage('modePage')" class="btn-gold shadow-lg mb-4">Select Mode</button>
        <button onclick="showPage('settingsPage')" class="mt-4 text-gray-400 font-bold">‚öôÔ∏è SETTINGS</button>
    </div>

    <div id="modePage" class="page">
        <h2 class="text-xl font-bold mb-8 tracking-wide">Select Your Challenge</h2>
        <div class="space-y-4 w-[85vw] max-w-xs">
            <button onclick="startGame('human', 'Friend Match')" class="w-full settings-btn border-l-4 border-blue-500">Vs Human (Local)</button>
            <button onclick="startGame(5, 'Sasha (Novice)')" class="w-full settings-btn border-l-4 border-yellow-500">Vs Bot Sasha (800)</button>
            <button onclick="startGame(15, 'Boris (GM)')" class="w-full settings-btn border-l-4 border-red-600">Vs GM Boris (2800)</button>
        </div>
        <button onclick="showPage('lobbyPage')" class="mt-12 text-gray-500 font-bold">‚óÄ BACK</button>
    </div>

    <div id="settingsPage" class="page">
        <h2 class="text-3xl font-black mb-10">SETTINGS</h2>
        <div class="space-y-4 w-[85vw] max-w-xs">
            <button onclick="showPage('leaderboardPage')" class="w-full settings-btn border-l-4 border-yellow-500">üèÜ Leaderboard</button>
            <div class="w-full settings-btn flex justify-between items-center border-l-4 border-blue-500">
                <span>Ambient Audio</span>
                <button id="mBtn" onclick="toggleMusic()" class="bg-red-900 px-4 py-1 rounded-full text-white text-sm font-normal">OFF</button>
            </div>
            <button onclick="resetScoreConfirmation()" class="w-full settings-btn border-l-4 border-red-600 text-red-400">üö® Reset My Score</button>
        </div>
        <button onclick="showPage('lobbyPage')" class="mt-12 text-gray-500 font-bold">‚óÄ BACK</button>
    </div>

    <div id="leaderboardPage" class="page">
        <h2 class="text-3xl font-black mb-6">LEADERBOARD</h2>
        <div id="rankDisplay" class="score-card mb-8 w-[80vw] max-w-xs">
            </div>
        <div class="w-[85vw] max-w-xs bg-[#262421] p-5 rounded-2xl">
            <h3 class="font-bold text-lg mb-2 border-b border-gray-600 pb-2">Ranking Tiers</h3>
            <div id="rankTiers">
                </div>
        </div>
        <button onclick="showPage('settingsPage')" class="mt-12 text-gray-500 font-bold">‚óÄ BACK TO SETTINGS</button>
    </div>
    
    <div id="gamePage" class="page">
        <div id="playerIndicator" class="w-[92vw] max-w-[450px] flex justify-between mb-2 text-white font-bold text-sm uppercase">
            <span id="playerBlack" class="px-3 py-1 rounded-md bg-gray-700 text-gray-400">Black</span>
            <span id="playerWhite" class="px-3 py-1 rounded-md bg-[#81b64c]">White</span>
        </div>
        
        <div id="status" class="text-[10px] font-bold text-[#81b64c] uppercase mb-4 tracking-widest">White to move</div>
        <div id="myBoard" class="shadow-2xl"></div>

        <div id="reviewControls" style="display:none;">
            <button onclick="exitReviewMode()">Exit Review</button>
            <button onclick="rewind()">‚ü≤ Rewind</button>
            <button onclick="forward()">‚ü≥ Forward</button>
            <button onclick="startReviewMode()">Start of Game</button>
        </div>

        <div class="w-[92vw] max-w-[450px] mt-6 space-y-2" id="arenaControls">
            <button onclick="resetGame()" class="w-full bg-[#57534e] py-4 rounded-2xl font-bold text-gray-300">New Game üîÑ</button>
            
            <div class="flex space-x-2">
                <button onclick="offerDraw()" class="w-1/2 bg-[#57534e] py-4 rounded-2xl font-bold text-gray-300">Offer Draw ü§ù</button>
                <button onclick="resignMatch()" class="w-1/2 bg-[#991b1b] py-4 rounded-2xl font-bold text-white">Resign üè≥Ô∏è</button>
            </div>
            <button onclick="exitToLobby()" class="w-full bg-[#3d3a37] py-4 rounded-2xl font-bold text-gray-300">Exit Arena</button>
            
            <button onclick="enterReviewMode()" id="reviewBtn" class="w-full bg-[#084c61] py-4 rounded-2xl font-bold text-white">Review Game üîç</button>
        </div>
    </div>

    <script>
        let board = null, game = new Chess(), difficulty = 0;
        let stockfish = null; 
        let isStockfishReady = false; 
        let pendingBotGame = null; 
        
        // --- REVIEW MODE VARIABLES ---
        let isReviewMode = false;
        let reviewGameHistory = [];
        let reviewHistoryIndex = -1; 
        
        // --- SCORING VARIABLES ---
        const STARTING_SCORE = 100;
        let playerScore = STARTING_SCORE;
        let playerRank = '';
        
        const sfx = { move: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_default/move-self.mp3'), capture: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_default/capture.mp3') };
        const music = new Audio('https://www.bensound.com/bensound-music/bensound-slowmotion.mp3'); music.loop = true;
        
        // --- SCORING & RANKING FUNCTIONS ---

        function getRank(score) {
            if (score >= 400) return { name: 'Grandmaster', trophy: 'üëë', color: 'text-yellow-400', threshold: 400 };
            if (score >= 300) return { name: 'Master', trophy: 'üèÜ', color: 'text-amber-500', threshold: 300 };
            if (score >= 200) return { name: 'Expert', trophy: 'ü•á', color: 'text-gray-300', threshold: 200 };
            if (score >= 100) return { name: 'Intermediate', trophy: 'ü•à', color: 'text-gray-400', threshold: 100 };
            return { name: 'Novice', trophy: 'ü•â', color: 'text-red-400', threshold: 0 };
        }

        const RANK_TIERS = [
            getRank(400),
            getRank(300),
            getRank(200),
            getRank(100),
            getRank(0)
        ].sort((a, b) => b.threshold - a.threshold);

        function loadPlayerScore() {
            const savedScore = localStorage.getItem('chessPlayerScore');
            if (savedScore !== null) {
                playerScore = parseInt(savedScore);
            }
            updateScoreUI();
        }

        function updateScore(delta = 0) {
            playerScore = Math.max(0, playerScore + delta); 
            localStorage.setItem('chessPlayerScore', playerScore);
            updateScoreUI();
        }

        function resetScore() {
            updateScore(STARTING_SCORE - playerScore); 
            alert("Your score has been reset to " + STARTING_SCORE + ".");
            showPage('settingsPage');
        }

        function resetScoreConfirmation() {
            if(confirm("Are you sure you want to reset your score to " + STARTING_SCORE + "? This action cannot be undone.")) {
                resetScore();
            }
        }

        function updateScoreUI() {
            const rankData = getRank(playerScore);
            playerRank = rankData.name;
            const html = `
                <div class="font-bold text-xl ${rankData.color}">${rankData.trophy} ${playerRank}</div>
                <div class="text-sm mt-1 text-gray-300">Score: ${playerScore}</div>
            `;
            $('#scoreDisplay').html(html);
            $('#rankDisplay').html(html);
            
            const tiersHtml = RANK_TIERS.map(rank => `
                <div class="rank-item">
                    <span class="font-bold ${rank.color}">${rank.trophy} ${rank.name}</span>
                    <span class="text-gray-400">Score: ${rank.threshold}+</span>
                </div>
            `).join('');
            $('#rankTiers').html(tiersHtml);
        }

        // --- UX/STATUS FUNCTIONS ---
        
        function flashReadyStatus() {
            if ($('#gamePage').hasClass('active-page') && $('#myBoard').hasClass('board-waiting')) {
                const $status = $('#status');
                const originalColor = $status.css('color');
                const nextStatusText = pendingBotGame 
                    ? pendingBotGame.label + " (Waiting for your move)" 
                    : "Engine Ready. Select a mode.";

                $status.text("‚úÖ READY TO PLAY!").css('color', '#15803d');
                
                setTimeout(() => {
                    $status.css('color', originalColor);
                    if ($('#myBoard').hasClass('board-waiting') || !$('#gamePage').hasClass('active-page')) {
                        $status.text(nextStatusText);
                    }
                }, 2000);
            }
        }
        
        function updatePlayerIndicators() {
            if (!board) return;
            // Review Mode overrides indicator based on current board position
            if (isReviewMode) {
                 const currentTurn = game.turn();
                 $('#playerWhite').toggleClass('bg-[#81b64c] text-white', currentTurn === 'w').toggleClass('bg-gray-700 text-gray-400', currentTurn !== 'w');
                 $('#playerBlack').toggleClass('bg-[#81b64c] text-white', currentTurn === 'b').toggleClass('bg-gray-700 text-gray-400', currentTurn !== 'b');
                 return;
            }

            if (game.game_over()) {
                $('#playerWhite, #playerBlack').removeClass('bg-[#81b64c]').addClass('bg-gray-700 text-gray-400');
                return;
            }

            if (game.turn() === 'w') {
                $('#playerWhite').addClass('bg-[#81b64c] text-white').removeClass('bg-gray-700 text-gray-400');
                $('#playerBlack').removeClass('bg-[#81b64c] text-white').addClass('bg-gray-700 text-gray-400');
            } else {
                $('#playerBlack').addClass('bg-[#81b64c] text-white').removeClass('bg-gray-700 text-gray-400');
                $('#playerWhite').removeClass('bg-[#81b64c] text-white').addClass('bg-gray-700 text-gray-400');
            }
        }


        // --- RESUME LOGIC ---

        window.addEventListener('pagehide', () => {
            if ($('#gamePage').hasClass('active-page') && !game.game_over()) {
                const gameState = {
                    fen: game.fen(),
                    difficulty: difficulty,
                    isBot: difficulty !== 'human',
                    status: $('#status').text() 
                };
                localStorage.setItem('chessResumeGame', JSON.stringify(gameState));
            }
        });

        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                loadResumeGame();
            }
        });

        function loadResumeGame() {
            const savedGame = localStorage.getItem('chessResumeGame');
            if (savedGame) {
                const state = JSON.parse(savedGame);
                
                if (game.load(state.fen) === false) { 
                    localStorage.removeItem('chessResumeGame');
                    return false;
                }
                
                difficulty = state.difficulty;
                board.position(state.fen);
                $('#status').text(state.status);
                
                if (state.isBot && !isStockfishReady) {
                    $('#status').html('Engine Loading... <span class="loader" style="width:12px; height:12px; margin-left:8px; border-width:2px; vertical-align:middle;"></span>');
                    $('#myBoard').addClass('board-waiting'); 
                    pendingBotGame = { level: state.difficulty, label: 'Resumed Game', fen: state.fen };
                } else {
                    $('#myBoard').removeClass('board-waiting');
                }
                
                showPage('gamePage');
                updatePlayerIndicators();
                
                if (game.game_over()) {
                    $('#reviewBtn').show();
                } else {
                    $('#reviewBtn').hide();
                }
                return true;
            }
            return false;
        }


        window.onload = () => {
            // 1. Initialise Chessboard and Load Score
            board = Chessboard('myBoard', { draggable: true, position: 'start', onDrop: onDrop, pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
            loadPlayerScore(); 

            // 2. Load Engine in background
            stockfish = new Worker('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');
            
            // 3. Centralised Engine Listener
            stockfish.onmessage = (e) => {
                if (!isStockfishReady && e.data.includes('Stockfish')) {
                    isStockfishReady = true;
                    flashReadyStatus();
                    
                    if (pendingBotGame) {
                        finalizeGame(pendingBotGame.level, pendingBotGame.label, pendingBotGame.fen);
                        $('#myBoard').removeClass('board-waiting');
                        
                        if (game.turn() === 'b') {
                             $('#status').text("Bot is thinking...");
                             stockfish.postMessage('position fen ' + game.fen());
                             stockfish.postMessage('go depth ' + pendingBotGame.level);
                        }
                        pendingBotGame = null;
                    }
                }
                
                if (e.data.startsWith('bestmove')) {
                    let best = e.data.split(' ')[1];
                    let mv = game.move({ from: best.slice(0,2), to: best.slice(2,4), promotion: 'q' });
                    board.position(game.fen());
                    mv.captured ? sfx.capture.play() : sfx.move.play();
                    checkGameOver();
                    $('#status').text("Your Turn");
                    updatePlayerIndicators();
                }
            };
            
            // 4. Initial Screen Flow: FAIL-SAFE IMPLEMENTED (1.5s splash)
            if (!loadResumeGame()) {
                setTimeout(() => {
                    showPage('lobbyPage');
                }, 1500); 
            }
            
            // 5. Initial Indicator Setup and Service Worker Registration
            updatePlayerIndicators(); 
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch((error)=>{
                    console.error('Service Worker registration failed:', error);
                });
            }
        };

        function showPage(p) { $('.page').removeClass('active-page'); $('#'+p).addClass('active-page'); }

        function triggerPopup(msg) {
            $('#perfMsg').text(msg).addClass('popup-active');
            setTimeout(() => $('#perfMsg').removeClass('popup-active'), 1200);
        }

        function finalizeGame(level, label, fen = 'start') {
            difficulty = level;
            $('#status').text(level === 'human' ? "White's Turn" : label + " (Waiting for your move)");
            game.load(fen);
            board.position(fen);
            showPage('gamePage');
            updatePlayerIndicators();
            $('#reviewBtn').hide(); 
        }

        function startGame(level, label) {
            const fen = 'start';
            if (level === 'human' || isStockfishReady) {
                $('#myBoard').removeClass('board-waiting');
                finalizeGame(level, label, fen);
            } else {
                pendingBotGame = { level: level, label: label, fen: fen };
                finalizeGame(level, label, fen); 
                
                $('#status').html('Engine Loading... <span class="loader" style="width:12px; height:12px; margin-left:8px; border-width:2px; vertical-align:middle;"></span>');
                $('#myBoard').addClass('board-waiting');
            }
        }
        
        function checkGameOver(isExitingReview = false) {
            updatePlayerIndicators();
            if (game.game_over()) {
                let msg = 'Game Over. ';
                let scoreChange = 0;
                
                if (game.in_checkmate()) {
                    const winner = game.turn() === 'w' ? 'Black' : 'White';
                    msg += winner + ' Wins by Checkmate!';
                    
                    if (difficulty !== 'human') {
                        scoreChange = game.turn() === 'w' ? -5 : 8; 
                    } else {
                        scoreChange = 0;
                    }

                } else if (game.in_draw()) {
                    msg += 'Draw by Stalemate, 50-move rule, or Repetition.';
                    scoreChange = 0;
                }
                
                $('#status').text(msg).css('color', '#d4af37');
                $('#myBoard').addClass('board-waiting').css('opacity', 1);
                
                if (!isExitingReview) {
                    updateScore(scoreChange); 
                }
                $('#reviewBtn').show();
                return true;
            }
            $('#reviewBtn').hide();
            return false;
        }

        function resetGame() {
            game.reset(); 
            board.start(); 
            $('#myBoard').removeClass('board-waiting').css('opacity', 1); 
            localStorage.removeItem('chessResumeGame'); 
            
            if (difficulty === 'human') {
                $('#status').text("White's Turn");
            } else {
                startGame(difficulty, difficulty === 5 ? 'Sasha (Novice)' : 'Boris (GM)');
            }
            updatePlayerIndicators();
            $('#reviewBtn').hide();
        }

        function offerDraw() {
            if (game.game_over() || isReviewMode) return;
            game.set_header('Result', '1/2-1/2');
            $('#status').text('Game Drawn by Agreement! ü§ù').css('color', '#d4af37');
            localStorage.removeItem('chessResumeGame');
            $('#myBoard').addClass('board-waiting').css('opacity', 1); 
            updateScore(0); 
            $('#reviewBtn').show();
        }
        
        function resignMatch() {
            if (game.game_over() || isReviewMode) return;
            const winner = game.turn() === 'w' ? 'Black' : 'White';
            $('#status').text(winner + ' Wins by Resignation! üè≥Ô∏è').css('color', '#d4af37');
            game.set_header('Result', winner === 'White' ? '1-0' : '0-1');
            localStorage.removeItem('chessResumeGame');
            $('#myBoard').addClass('board-waiting').css('opacity', 1); 
            
            if (difficulty !== 'human') {
                 updateScore(-5);
            }
            $('#reviewBtn').show();
        }

        function exitToLobby() {
            if (isReviewMode) exitReviewMode();
            showPage('lobbyPage');
            updateScoreUI(); 
        }

        function onDrop(source, target) {
            if ($('#myBoard').hasClass('board-waiting') && !isReviewMode || (!isReviewMode && game.game_over())) {
                return 'snapback';
            }
            
            let m = game.move({ from: source, to: target, promotion: 'q' });
            if (m === null) return 'snapback';
            
            // GHOST MODE: Allow moves, but bypass all scoring, AI, and game over checks
            if (isReviewMode) {
                m.captured ? sfx.capture.play() : sfx.move.play();
                board.position(game.fen());
                $('#status').text(`GHOST MOVE: ${m.san}`).css('color', '#084c61');
                updatePlayerIndicators();
                return; // END EXECUTION FOR REVIEW MODE
            }
            
            // --- Normal Game Flow ---
            
            if (m.captured) triggerPopup("Sharp Capture!");
            else if (m.san.includes('+')) triggerPopup("Brilliant Check!");
            else triggerPopup("Strong Move");

            m.captured ? sfx.capture.play() : sfx.move.play();
            
            updatePlayerIndicators(); 

            if (checkGameOver()) return;

            if (difficulty !== 'human' && !game.game_over()) {
                $('#status').text("Bot is thinking...");
                stockfish.postMessage('position fen ' + game.fen());
                stockfish.postMessage('go depth ' + difficulty);
            } else if (difficulty === 'human') {
                $('#status').text(game.turn() === 'w' ? "White's Turn" : "Black's Turn");
            }
        }

        function toggleMusic() {
            const isPaused = music.paused;
            if (isPaused) { 
                music.play(); 
                $('#mBtn').text('ON').css('background','#15803d'); 
            }
            else { 
                music.pause(); 
                $('#mBtn').text('OFF').css('background','#991b1b'); 
            }
        }
        
        // --- REVIEW MODE LOGIC ---
        
        function enterReviewMode() {
            if (!game.history().length) {
                alert("Cannot review an empty game.");
                return;
            }
            if (isReviewMode) return;
            
            isReviewMode = true;
            reviewGameHistory = game.history({ verbose: true });
            reviewHistoryIndex = reviewGameHistory.length - 1; 

            $('#reviewControls').show();
            $('#arenaControls').hide();
            
            game.load(game.fen());
            board.position(game.fen());
            
            $('#status').text("ANALYSIS MODE: GHOST MOVES ENABLED").css('color', '#084c61');
            updatePlayerIndicators();
        }

        function exitReviewMode() {
            isReviewMode = false;
            
            if (reviewGameHistory.length) {
                game.load(reviewGameHistory[reviewGameHistory.length - 1].after);
            } else {
                game.reset();
            }

            $('#reviewControls').hide();
            $('#arenaControls').show();
            
            checkGameOver(true);
            updatePlayerIndicators();
        }

        function rewind() {
            if (!isReviewMode) return;
            
            if (game.history().length > reviewHistoryIndex + 1) {
                game.undo();
            } else if (reviewHistoryIndex >= 0) {
                game.undo();
                reviewHistoryIndex--;
            }
            board.position(game.fen());
            
            const currentMove = game.history().length;
            $('#status').text(`ANALYSIS MODE | Move: ${currentMove}/${reviewGameHistory.length}`);
            updatePlayerIndicators();
        }

        function forward() {
            if (!isReviewMode) return;
            
            if (reviewHistoryIndex < reviewGameHistory.length - 1) {
                reviewHistoryIndex++;
                game.move(reviewGameHistory[reviewHistoryIndex].san);
            }
            board.position(game.fen());

            const currentMove = game.history().length;
            $('#status').text(`ANALYSIS MODE | Move: ${currentMove}/${reviewGameHistory.length}`);
            updatePlayerIndicators();
        }

        function startReviewMode() {
            if (!isReviewMode) enterReviewMode();
            game.reset();
            reviewHistoryIndex = -1;
            board.position(game.fen());
            $('#status').text(`ANALYSIS MODE | Move: 0/${reviewGameHistory.length}`);
            updatePlayerIndicators();
        }
        
    </script>
</body>
</html>
