<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chess Master Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <style>
        :root { --main-bg: #312e2b; --gold: #d4af37; }
        body { background: var(--main-bg); color: white; margin: 0; padding: env(safe-area-inset-top) 0; font-family: sans-serif; overflow-x: hidden; }
        
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #81b64c; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .page { display: none; min-height: 100vh; width: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .active-page { display: flex; }
        #myBoard { width: 92vw; max-width: 450px; }
        .board-waiting { opacity: 0.5; pointer-events: none; } 
        
        .btn-gold { background: var(--gold); color: black; font-weight: 800; padding: 15px 40px; border-radius: 50px; text-transform: uppercase; transition: 0.2s; }
        .btn-gold:active { transform: scale(0.95); }
        .performance-popup { position: absolute; top: 12%; background: rgba(129, 182, 76, 0.95); color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; transform: scale(0); transition: 0.3s; z-index: 100; pointer-events: none; }
        .popup-active { transform: scale(1.1); }
        .bot-card { background: #3d3a37; padding: 15px; border-radius: 12px; width: 85vw; max-width: 400px; text-align: left; }
    </style>
</head>
<body>

    <div id="perfMsg" class="performance-popup">Brilliant!!</div>

    <div id="splashPage" class="page active-page">
        <h1 class="text-4xl font-black text-[#81b64c] mb-6">CHESS PRO</h1>
        <span class="loader"></span>
        <p class="mt-4 text-[10px] uppercase tracking-widest text-gray-500">Initializing Grandmaster AI...</p>
    </div>

    <div id="lobbyPage" class="page">
        <img src="https://images.unsplash.com/photo-1529699211952-734e80c4d42b?q=80&w=600" class="w-[80vw] max-w-xs rounded-2xl shadow-2xl mb-10 border-2 border-gray-700">
        <button onclick="showPage('modePage')" class="btn-gold shadow-lg mb-10">Select Mode</button>
        <div class="w-[90vw] max-w-sm bg-[#262421] p-6 rounded-3xl space-y-4">
            <div class="flex items-center justify-between text-gray-400 font-bold uppercase text-[10px]">
                <span>Ambient Audio</span>
                <button id="mBtn" onclick="toggleMusic()" class="bg-red-900 px-4 py-1 rounded-full text-white">OFF</button>
            </div>
        </div>
    </div>

    <div id="modePage" class="page">
        <h2 class="text-xl font-bold mb-8 tracking-wide">Select Your Challenge</h2>
        <div class="space-y-4 w-[85vw] max-w-xs">
            <button onclick="startGame('human', 'Friend Match')" class="w-full bg-[#3d3a37] p-5 rounded-2xl font-bold text-left border-l-4 border-blue-500">Vs Human (Local)</button>
            <button onclick="startGame(5, 'Sasha (Novice)')" class="w-full bg-[#3d3a37] p-5 rounded-2xl font-bold text-left border-l-4 border-yellow-500">Vs Bot Sasha (800)</button>
            <button onclick="startGame(15, 'Boris (GM)')" class="w-full bg-[#3d3a37] p-5 rounded-2xl font-bold text-left border-l-4 border-red-600">Vs GM Boris (2800)</button>
        </div>
        <button onclick="showPage('lobbyPage')" class="mt-12 text-gray-500 font-bold">‚óÄ BACK</button>
    </div>
    
    <div id="gamePage" class="page">
        <div id="status" class="text-[10px] font-bold text-[#81b64c] uppercase mb-4 tracking-widest">White to move</div>
        <div id="myBoard" class="shadow-2xl"></div>
        <div class="w-[92vw] max-w-[450px] mt-6 space-y-2">
            <div class="flex space-x-2">
                <button onclick="offerDraw()" class="w-1/2 bg-[#57534e] py-4 rounded-2xl font-bold text-gray-300">Offer Draw ü§ù</button>
                <button onclick="resignMatch()" class="w-1/2 bg-[#991b1b] py-4 rounded-2xl font-bold text-white">Resign üè≥Ô∏è</button>
            </div>
            <button onclick="exitToLobby()" class="w-full bg-[#3d3a37] py-4 rounded-2xl font-bold text-gray-300">Exit Arena</button>
        </div>
    </div>

    <script>
        let board = null, game = new Chess(), difficulty = 0;
        let stockfish = null; 
        let isStockfishReady = false; 
        let pendingBotGame = null; 
        
        const sfx = { move: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_default/move-self.mp3'), capture: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_default/capture.mp3') };
        const music = new Audio('https://www.bensound.com/bensound-music/bensound-slowmotion.mp3'); music.loop = true;
        
        // Function to flash the "Ready to Play" message
        function flashReadyStatus() {
            // Only flash if the game page is currently active and in a waiting state
            if ($('#gamePage').hasClass('active-page') && $('#myBoard').hasClass('board-waiting')) {
                const $status = $('#status');
                const originalColor = $status.css('color');
                
                // 1. Flash Green
                $status.text("‚úÖ READY TO PLAY!").css('color', '#15803d');
                
                // If a pending game exists, the finalizeGame call below will set the correct status
                // If no pending game, it reverts to the neutral waiting status
                const nextStatusText = pendingBotGame 
                    ? pendingBotGame.label + " (Waiting for your move)" 
                    : "Engine Ready. Select a mode.";

                // 2. Revert after 2 seconds
                setTimeout(() => {
                    $status.css('color', originalColor);
                    
                    // Only revert status text if the game is still waiting or if we are still on the lobby page
                    if ($('#myBoard').hasClass('board-waiting') || !$('#gamePage').hasClass('active-page')) {
                        $status.text(nextStatusText);
                    }
                }, 2000);
            }
        }
        
        // --- Fast Resume Logic ---
        window.addEventListener('pagehide', () => {
            if ($('#gamePage').hasClass('active-page') && !game.game_over()) {
                const gameState = {
                    fen: game.fen(),
                    difficulty: difficulty,
                    isBot: difficulty !== 'human',
                    status: $('#status').text() 
                };
                localStorage.setItem('chessResumeGame', JSON.stringify(gameState));
            }
        });

        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                loadResumeGame();
            }
        });

        function loadResumeGame() {
            const savedGame = localStorage.getItem('chessResumeGame');
            if (savedGame) {
                const state = JSON.parse(savedGame);
                
                if (game.load(state.fen) === false) { 
                    localStorage.removeItem('chessResumeGame');
                    return false;
                }
                
                difficulty = state.difficulty;
                board.position(state.fen);
                $('#status').text(state.status);
                
                if (state.isBot && !isStockfishReady) {
                    $('#status').html('Engine Loading... <span class="loader" style="width:12px; height:12px; margin-left:8px; border-width:2px; vertical-align:middle;"></span>');
                    $('#myBoard').addClass('board-waiting'); 
                    // This sets the pending game object needed when Stockfish finally loads
                    pendingBotGame = { level: state.difficulty, label: 'Resumed Game', fen: state.fen };
                } else {
                    $('#myBoard').removeClass('board-waiting');
                }
                
                showPage('gamePage');
                return true;
            }
            return false;
        }
        // --- End Fast Resume Logic ---


        window.onload = () => {
            // 1. Initialise Chessboard
            board = Chessboard('myBoard', { draggable: true, position: 'start', onDrop: onDrop, pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
            
            // 2. Load Engine in background
            stockfish = new Worker('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');
            
            // 3. Centralised Engine Listener
            stockfish.onmessage = (e) => {
                if (!isStockfishReady && e.data.includes('Stockfish')) {
                    isStockfishReady = true;
                    flashReadyStatus(); // Flash message when ready
                    
                    if (pendingBotGame) {
                        // Stockfish is now ready, finalize the waiting game
                        finalizeGame(pendingBotGame.level, pendingBotGame.label, pendingBotGame.fen);
                        $('#myBoard').removeClass('board-waiting');
                        
                        if (game.turn() === 'b') {
                             $('#status').text("Bot is thinking...");
                             stockfish.postMessage('position fen ' + game.fen());
                             stockfish.postMessage('go depth ' + pendingBotGame.level);
                        }
                        pendingBotGame = null;
                    }
                }
                
                if (e.data.startsWith('bestmove')) {
                    let best = e.data.split(' ')[1];
                    let mv = game.move({ from: best.slice(0,2), to: best.slice(2,4), promotion: 'q' });
                    board.position(game.fen());
                    mv.captured ? sfx.capture.play() : sfx.move.play();
                    checkGameOver();
                    $('#status').text("Your Turn");
                }
            };
            
            // 4. Initial Screen Flow: FIX: Set timeout to 0ms for instant lobby load
            // The Stockfish worker starts above and runs in the background.
            if (!loadResumeGame()) {
                setTimeout(() => showPage('lobbyPage'), 0); 
            }
            
            // 5. Service Worker Registration
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch((error)=>{
                    console.error('Service Worker registration failed:', error);
                });
            }
        };
        
        // --- Game Flow Functions ---

        function showPage(p) { $('.page').removeClass('active-page'); $('#'+p).addClass('active-page'); }

        function triggerPopup(msg) {
            $('#perfMsg').text(msg).addClass('popup-active');
            setTimeout(() => $('#perfMsg').removeClass('popup-active'), 1200);
        }

        function finalizeGame(level, label, fen = 'start') {
            difficulty = level;
            $('#status').text(level === 'human' ? "White's Turn" : label + " (Waiting for your move)");
            game.load(fen);
            board.position(fen);
            showPage('gamePage');
        }

        function startGame(level, label) {
            const fen = 'start';
            if (level === 'human' || isStockfishReady) {
                $('#myBoard').removeClass('board-waiting');
                finalizeGame(level, label, fen);
            } else {
                pendingBotGame = { level: level, label: label, fen: fen };
                finalizeGame(level, label, fen); 
                
                $('#status').html('Engine Loading... <span class="loader" style="width:12px; height:12px; margin-left:8px; border-width:2px; vertical-align:middle;"></span>');
                $('#myBoard').addClass('board-waiting');
            }
        }
        
        function checkGameOver() {
            if (game.game_over()) {
                let msg = 'Game Over. ';
                if (game.in_checkmate()) {
                    msg += game.turn() === 'w' ? 'Black Wins by Checkmate!' : 'White Wins by Checkmate!';
                } else if (game.in_draw()) {
                    msg += 'Draw by Stalemate, 50-move rule, or Repetition.';
                }
                $('#status').text(msg).css('color', '#d4af37');
                $('#myBoard').addClass('board-waiting').css('opacity', 1);
                return true;
            }
            return false;
        }

        function offerDraw() {
            if (game.game_over()) return;
            game.set_header('Result', '1/2-1/2');
            $('#status').text('Game Drawn by Agreement! ü§ù').css('color', '#d4af37');
            localStorage.removeItem('chessResumeGame');
            $('#myBoard').addClass('board-waiting').css('opacity', 1); 
        }
        
        function resignMatch() {
            const winner = game.turn() === 'w' ? 'Black' : 'White';
            $('#status').text(winner + ' Wins by Resignation! üè≥Ô∏è').css('color', '#d4af37');
            game.set_header('Result', winner === 'White' ? '1-0' : '0-1');
            localStorage.removeItem('chessResumeGame');
            $('#myBoard').addClass('board-waiting').css('opacity', 1); 
        }

        function exitToLobby() {
            showPage('lobbyPage');
        }

        function onDrop(source, target) {
            if ($('#myBoard').hasClass('board-waiting') || game.game_over()) {
                return 'snapback';
            }
            
            let m = game.move({ from: source, to: target, promotion: 'q' });
            if (m === null) return 'snapback';
            
            if (m.captured) triggerPopup("Sharp Capture!");
            else if (m.san.includes('+')) triggerPopup("Brilliant Check!");
            else triggerPopup("Strong Move");

            m.captured ? sfx.capture.play() : sfx.move.play();
            
            if (checkGameOver()) return;

            if (difficulty !== 'human' && !game.game_over()) {
                $('#status').text("Bot is thinking...");
                stockfish.postMessage('position fen ' + game.fen());
                stockfish.postMessage('go depth ' + difficulty);
            } else if (difficulty === 'human') {
                $('#status').text(game.turn() === 'w' ? "White's Turn" : "Black's Turn");
            }
        }

        function toggleMusic() {
            if (music.paused) { music.play(); $('#mBtn').text('ON').css('background','#15803d'); }
            else { music.pause(); $('#mBtn').text('OFF').css('background','#991b1b'); }
        }
    </script>
</body>
</html>
